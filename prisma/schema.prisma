generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Area {
  TALENTO
  FINANZAS
  OPERACIONES
  COMUNICACION
  SISTEMAS
}

model Company {
  id              String          @id @default(cuid())
  name            String
  slug            String          @unique
  logo            String?
  primaryColor    String?         @default("#14B8A6")
  plan            String          @default("STANDARD")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  moduleOverrides CompanyModule[]
  courses         Course[]
  programs        Program[]
  users           User[]
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String?
  password              String?
  role                  String                 @default("COLABORADOR")
  avatar                String?
  position              String?
  department            String?
  isActive              Boolean                @default(true)
  area                  String?
  assignedAreas         String?
  companyId             String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  certificates          Certificate[]
  comments              Comment[]
  teachingCourses       Course[]               @relation("TeacherCourses")
  diagnosticResults     DiagnosticResult[]
  enrollments           Enrollment[]
  evaluationSubmissions EvaluationSubmission[]
  repliedInquiries      Inquiry[]              @relation("TeacherInquiries")
  studentInquiries      Inquiry[]              @relation("StudentInquiries")
  progress              Progress[]
  company               Company?               @relation(fields: [companyId], references: [id])
}

model Course {
  id           String        @id @default(cuid())
  title        String
  slug         String        @unique
  description  String?
  thumbnail    String?
  duration     Int?
  level        String        @default("BEGINNER")
  modality     String        @default("ELEARNING")
  category     String?
  published    Boolean       @default(false)
  companyId    String
  teacherId    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  certificates Certificate[]
  teacher      User?         @relation("TeacherCourses", fields: [teacherId], references: [id])
  company      Company       @relation(fields: [companyId], references: [id])
  enrollments  Enrollment[]
  evaluations  Evaluation[]
  inquiries    Inquiry[]
  modules      Module[]
}

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Lesson {
  id          String       @id @default(cuid())
  title       String
  content     String?
  contentType String       @default("VIDEO")
  videoUrl    String?
  duration    Int?
  order       Int
  moduleId    String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  comments    Comment[]
  evaluations Evaluation[]
  module      Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress    Progress[]
  resources   Resource[]
}

model Resource {
  id        String   @id @default(cuid())
  title     String
  url       String
  type      String
  lessonId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  lessonId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}

model Enrollment {
  id          String    @id @default(cuid())
  status      String    @default("ACTIVE")
  progress    Float     @default(0)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model Progress {
  id          String    @id @default(cuid())
  completed   Boolean   @default(false)
  completedAt DateTime?
  timeSpent   Int       @default(0)
  userId      String
  lessonId    String
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Certificate {
  id             String   @id @default(cuid())
  code           String   @unique
  certificateUrl String
  issuedAt       DateTime @default(now())
  userId         String
  courseId       String
  course         Course   @relation(fields: [courseId], references: [id])
  user           User     @relation(fields: [userId], references: [id])

  @@unique([userId, courseId])
}

model Program {
  id          String   @id @default(cuid())
  name        String
  description String?
  year        Int
  budget      Float?
  startDate   DateTime
  endDate     DateTime
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  phases      Phase[]
  company     Company  @relation(fields: [companyId], references: [id])
}

model Phase {
  id        String   @id @default(cuid())
  name      String
  order     Int
  startDate DateTime
  endDate   DateTime
  programId String
  program   Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model Diagnostic {
  id          String               @id @default(cuid())
  title       String
  description String
  category    String
  published   Boolean              @default(false)
  createdAt   DateTime             @default(now())
  questions   DiagnosticQuestion[]
  results     DiagnosticResult[]
}

model DiagnosticQuestion {
  id            String     @id @default(cuid())
  diagnosticId  String
  question      String
  type          String
  options       String
  correctAnswer String?
  points        Int        @default(1)
  order         Int
  diagnostic    Diagnostic @relation(fields: [diagnosticId], references: [id], onDelete: Cascade)

  @@index([diagnosticId])
}

model DiagnosticResult {
  id           String     @id @default(cuid())
  userId       String
  diagnosticId String
  score        Int
  maxScore     Int
  level        String
  answers      String
  completedAt  DateTime   @default(now())
  diagnostic   Diagnostic @relation(fields: [diagnosticId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@unique([userId, diagnosticId])
  @@index([userId])
  @@index([diagnosticId])
}

model Evaluation {
  id           String                 @id @default(cuid())
  lessonId     String?
  courseId     String?
  title        String
  description  String?
  type         String
  passingScore Int                    @default(70)
  attempts     Int                    @default(3)
  timeLimit    Int?
  published    Boolean                @default(false)
  createdAt    DateTime               @default(now())
  course       Course?                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson       Lesson?                @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions    EvaluationQuestion[]
  submissions  EvaluationSubmission[]

  @@index([lessonId])
  @@index([courseId])
}

model EvaluationQuestion {
  id            String     @id @default(cuid())
  evaluationId  String
  question      String
  type          String
  options       String
  correctAnswer String
  explanation   String?
  points        Int        @default(1)
  order         Int
  evaluation    Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
}

model EvaluationSubmission {
  id           String     @id @default(cuid())
  evaluationId String
  userId       String
  answers      String
  score        Int
  maxScore     Int
  percentage   Float
  passed       Boolean
  attempt      Int
  feedback     String?
  reviewedBy   String?
  reviewedAt   DateTime?
  submittedAt  DateTime   @default(now())
  user         User       @relation(fields: [userId], references: [id])
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id])

  @@index([userId])
  @@index([evaluationId])
  @@index([reviewedBy])
}

model Inquiry {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  teacherId String?
  question  String
  answer    String?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teacher   User?    @relation("TeacherInquiries", fields: [teacherId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])
  student   User     @relation("StudentInquiries", fields: [studentId], references: [id])
}

model SystemModule {
  id           String          @id @default(cuid())
  key          String          @unique
  name         String
  description  String
  status       String          @default("ACTIVE")
  version      String          @default("1.0.0")
  dependencies String?
  updatedAt    DateTime        @updatedAt
  updatedBy    String?
  overrides    CompanyModule[]
}

model CompanyModule {
  id        String       @id @default(cuid())
  moduleKey String
  companyId String
  status    String
  updatedAt DateTime     @updatedAt
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  module    SystemModule @relation(fields: [moduleKey], references: [key], onDelete: Cascade)

  @@unique([companyId, moduleKey])
}
